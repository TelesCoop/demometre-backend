{% extends "wagtailadmin/base.html" %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .vertical {
            display: flex;
            flex-direction: column;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 30%;
            top: 30%;
            width: 50%;
            height: 200px;
            overflow: auto;
          }
          .modal-content {
            border: 1px solid #888;
            padding: 10px;
            background-color: #fefefe;
          }
          .close {
            position: absolute;
            right: 5px;
            top: 5px;
            width: auto;
            font-size: 20px;
            font-weight: bold;
            color: #474e5d;
          }
    </style>
{% endblock %}

{% block content %}
    {% include "wagtailadmin/shared/header.html" with title="Modal Title" icon="no-view" %}

    <div class="nice-padding">
        <h1>Conditions d'affichage pour la question : <i>{{ question }}</i></h1>
        {% if question_filters.count > 0 %}
            <h2>Conditions d'affichage déjà existantes</h2>
            <ul class="vertical">
                {% for question_filter in question_filters %}
                    <span style="text-transform:uppercase; margin: 10px 0;">{% if question_filter.intersection_operator %}{{ question_filter.intersection_operator }}{% endif %}</span>
                    <li>

                        <b>{{ question_filter.conditional_question }}</b><br/>
                        {% if question_filter.response_choices.count > 0 %}
                            (Lien logique : ou)
                            {% for response_choice in question_filter.response_choices.all %}
                                réponse = {{ response_choice }}
                            {% endfor %}
                        {% endif %}
                        {% if question_filter.numerical_operator %}
                            réponse {{ question_filter.numerical_operator }} {{ question_filter.numerical_value }}
                        {% endif %}
                        {% if question_filter.boolean_response %}
                            réponse = {{ question_filter.boolean_response }}
                        {% endif %}
                        <button onclick="document.getElementById('confirm-delete-{{ question_filter.id }}').style.display='block'">Supprimer</button>
                    </li>

                    <div id="confirm-delete-{{ question_filter.id }}" class="modal">
                        <form class="modal-content" action="{% url 'delete-filter' question.id question_filter.id %}" method="post">
                            {% csrf_token %}
                            <span onclick="document.getElementById('confirm-delete-{{ question_filter.id }}').style.display='none'" class="close" title="Close Modal">×</span>
                            <div class="container">
                                <h1>Supprimer une condition d'affichage</h1>
                                <p>Vous êtes sur le point de supprimer : {{ question_filter }}</p>
                                <div class="clearfix">
                                    <button type="button" onclick="document.getElementById('confirm-delete-{{ question_filter.id }}').style.display='none'" class="cancelbtn">Cancel</button>
                                    <input type="submit" value="Supprimer" onclick="document.getElementById('confirm-delete-{{ question_filter.id }}').style.display='none'">
                                </div>
                            </div>
                        </form>
                      </div>

                {% endfor %}
            </ul>
        {% endif %}

        <h2>Créer une nouvelle condition d'affichage</h2>
        <form action="{% url 'filter' question.id %}" method="post">
            {% csrf_token %}
            {{ filter_form.question.as_hidden }}
            {% if question_filters.count > 0 %}
                <div>
                    {{ filter_form.intersection_operator.error }}
                    {{ filter_form.intersection_operator.label_tag }}
                    {{ filter_form.intersection_operator }}
                </div>
            {% endif %}

            <div>
                {{ filter_form.conditional_question.error }}
                {{ filter_form.conditional_question.label_tag }}
                {{ filter_form.conditional_question }}
            </div>

            <div id="id_display_response_choices" style="display: none;">
                {{ filter_form.response_choices.error }}
                {{ filter_form.response_choices.label_tag }}
                {{ filter_form.response_choices }}
            </div>
            <div id="id_display_scale_response" style="display: none;">
            </div>
            <div id="id_display_numerical_response" style="display: none;">
                {{ filter_form.numerical_operator.error }}
                {{ filter_form.numerical_operator.label_tag }}
                {{ filter_form.numerical_operator }}
                {{ filter_form.numerical_value.error }}
                {{ filter_form.numerical_value.label_tag }}
                {{ filter_form.numerical_value }}
            </div>
            <div id="id_display_boolean_response" style="display: none;">
                {{ filter_form.boolean_response.error }}
                {{ filter_form.boolean_response.label_tag }}
                {{ filter_form.boolean_response }}
            </div>
            <br/>
            <input type="submit" value="Ajouter">
        </form>
        <a class="btn btn-primary" href="/admin/snippets/open_democracy_back/question/">Terminer</a>
    </div>

    <script type="text/javascript">
        const OTHER_QUESTIONS_RESPONSE_BY_ID = JSON.parse("{{other_questions_response_by_id | escapejs }}");
        console.log(OTHER_QUESTIONS_RESPONSE_BY_ID)

        var new_question_filter = document.getElementById("id_conditional_question");
        var display_response_choices = document.getElementById("id_display_response_choices");
        var display_scale_response = document.getElementById("id_display_scale_response");
        var display_numerical_response = document.getElementById("id_display_numerical_response");
        var display_boolean_response = document.getElementById("id_display_boolean_response");

        new_question_filter.addEventListener("change", function() {
            const new_question_filter_type = OTHER_QUESTIONS_RESPONSE_BY_ID[new_question_filter.value].type
            if (new_question_filter_type == "unique_choice" || new_question_filter_type == "multiple_choice"){
                var str = ""
                for (const [response_choice_id, response_choice] of Object.entries(OTHER_QUESTIONS_RESPONSE_BY_ID[new_question_filter.value].responses)) {
                    var id = "id_response_choices_" + response_choice_id
                    str += "<li><label for='" + id + "'>"
                        + "<input type='checkbox' name='response_choices' value='" + response_choice_id + "' id='" + id + "'></input>"
                        + response_choice
                        + "</label></li>"
                }
                document.getElementById("id_response_choices").innerHTML = str;
                display_response_choices.style.display =  "block";
            } else {
                display_response_choices.style.display =  "none";
            }

            if (new_question_filter_type == "numerical" || new_question_filter_type == "closed_with_scale") {
                display_numerical_response.style.display =  "block";
            } else {
                display_numerical_response.style.display =  "none";
            }

            if (new_question_filter_type == "closed_with_scale") {
                display_scale_response.innerHTML = "La réponse est contenu entre "
                    + OTHER_QUESTIONS_RESPONSE_BY_ID[new_question_filter.value].min
                    + " et "
                    + OTHER_QUESTIONS_RESPONSE_BY_ID[new_question_filter.value].max
                display_scale_response.style.display =  "block";
            } else {
                display_scale_response.style.display =  "none";
            }

            if (new_question_filter_type == "boolean") {
                display_boolean_response.style.display =  "block";
            } else {
                display_boolean_response.style.display =  "none";
            }
        });
    </script>

{% endblock %}
